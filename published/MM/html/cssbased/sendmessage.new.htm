<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
	<head>
		<? wbs_initLayout ?>
		<link href="../../../MM/html/classic/stylesets/default/mm_options.css" rel="stylesheet" type="text/css">
		<script src="../../../common/html/includes/modules/JsHttpRequest/JsHttpRequest.js"></script>
		<script src="../../../common/html/classic/styles/calendar.js" type="text/javascript"></script>
		<script language="JavaScript">
		<!--

			function fillSelected()
			{
				arr = new Array('includedContacts[]', 'contactsForInclude[]' );
				fillSelectedLists( arr );
			}

			function moveDeleteComboItems( src, dest, del )
			{
				srcObj = findObj(src);

				if (dest != null )
					destObj = findObj(dest);

				if ( dest != null )
					for ( i = 0; i < srcObj.options.length; i++ )
					{
						selObj = srcObj.options[i];
						if ( selObj.selected )
						{
							curPos = destObj.length;
							destObj.options[curPos] = new Option(selObj.text, selObj.value);

							if ( selObj.className )
								destObj.options[curPos].className = selObj.className;
						}
					}

				deletedNum = 0;
				first = 1;

				if ( del )
					while ( deletedNum || first )
					{
						deletedNum = 0;
						for ( i = 0; i < srcObj.options.length; i++ )
						{
							selObj = srcObj.options[i];

							if ( selObj.selected ) {
								srcObj.options[selObj.index] = null;
								deletedNum ++;
							}
						}
						first = 0;
					}
			}

			function onSendingMesages( btnid, fill )
			{
				if ( fill )
					fillSelected();

				thisForm = document.forms[0];

				if ( document.getElementById )
				{

					var timemsg = document.getElementById( 'timeMessage' );
					if ( timemsg )
						timemsg.style.display = "none";

					var error = document.getElementById( 'ErrorBlock' );
					if ( error )
						error.style.display = "none";

					var addFileCell = document.getElementById( 'optionscell' );
					if (addFileCell)
						addFileCell.style.display = "none";

					var attachMessageCell = document.getElementById( 'waitingcell' );
					if (attachMessageCell)
						attachMessageCell.style.display = "inline";
				}

				processTextButton(  btnid, 'form' );

				return false;
			}

			function toggleVisibility( id )
			{
				var el = document.getElementById(id)

				if ( el )
				{
					if ( el.style.display == 'none' )
						el.style.display = '';
					else
						el.style.display = 'none';
				}

				return false;
			}

			function getRadioValue ( property )
			{
				var retVal;
				var i=0;

				if (document.form[property] )
					while (i < 48)
					{
						if (document.form[property][i] && document.form[property][i].checked )
							return document.form[property][i].value;
						i++;
					}

				return '';
			}

			function getTextValue( property )
			{
				 var retVal;
				 var i=0;

				 var p = document.getElementById( property );

				 if ( p!=null )
					 return p.value;

				 return '';
			}

			function getListboxValue ( property )
			{
				 var p = document.getElementById( property );

				 if ( p==null )
					 return '';

				 return p[p.selectedIndex].value;
			}

			function escape(s)
			{
				return s.replace(new RegExp('\\/','g'), '%2F');
			}

			function checkDate()
			{

				var req = new Subsys_JsHttpRequest_Js();

				if ( getRadioValue( 'messageData[WHEN]' )  != 'later' )
				{
					onSendingMesages('sendbtn', true);
					return false;
				}

				var timemsg = document.getElementById( 'timeMessage' );
				if ( timemsg )
					timemsg.style.display = "none";

				req.onreadystatechange = function()
				{
					if (req.readyState == 4)
					{
						if (req.responseJS)
						{
							if ( req.responseJS.state == "OK" )
								onSendingMesages('sendbtn', true);
							else
							{
								var timemsg = document.getElementById( 'timeMessage' );
								if ( timemsg )
									timemsg.style.display = "";
							}

						}
					}
				}

				req.open('POST', 'time.php', true);

				var dt = getTextValue( 'messageData[WHENDATE]' );
				var tm = getListboxValue( 'messageData[WHENTIME]' );

				req.send( { DB_KEY: '<? $DB_KEY ?>', DATE: dt, TIME: tm, FORMAT: '<?$dateformat?>' } );

				return false;
			}
			function hideLayer(layer) {
				$(layer).style.display = 'none';
				$('messageData[WHENDATE]').value = '';
				$('messageData[WHENTIME]').value = '00:00';
			}
			function showLayer(layer) {
				$(layer).style.display = 'block';
			}
		//-->
		</script>

	</head>
	<body onLoad="autoFocusFormControl( '<? $invalidField ?>', 'messageData' )<? if $messageData.WHEN!='later' ?>;hideLayer('layer')<? /if ?>">
		<? wbs_pageLayout toolbar="sendmessage_toolbar.htm" ?>
			<? wbs_errorBlock ?>

			<span id="timeMessage" class="ErrorBlock" style="display: none;"><span>
				<? $mmStrings.sm_date_select_error ?>
			</span></span>

			<? if !$fatalError ?>

				<? if !$messagesSent ?>

				<? if !$informationGathered ?>

					<div id="optionscell">

					<? if $doclistCount != 1?>
						<? wbs_note displayNoteMarker=false width="500px" smallFont=false ?>
							<? $messageCount ?> <? $mmStrings.sm_messages_label ?>	<? if $messageCount != $doclistCount ?> (<? $mmStrings.sm_tplsent_excluded_text ?>) <? /if ?>
						<? /wbs_note ?>
					<? /if ?>

					<? foreach from=$messageList item=message ?>
						<? if $messageCount == 1 && $doclistCount == 1?>
							<? wbs_formCaption text=$message.MMM_SUBJECT|htmlsafe:true:true ?>
						<? else ?>
							<b><? $message.MMM_SUBJECT|htmlsafe:true:true ?></b><br>
						<? /if ?>
					<? /foreach ?>

					<? if $doclistCount != 1?>
						<br>
					<? /if ?>

					<? wbs_formLayout ?>
						<? wbs_formContent ?>

								<? if !$noSenderEmail ?>
								<tr class="SeparatedRow">
									<td>
										<? wbs_label for="messageData[PRIORITY]" fieldName="PRIORITY" text=$mmStrings.sm_priority_label skipColon=false ?>
									<td>
										<table cellpadding=0 cellspacing=0 border=0>
										<tr>
											<td>
												<select name="messageData[PRIORITY]" id="messageData[PRIORITY]" class="FormControl">
													<? html_options values=$priorityValues selected=$messageData.PRIORITY output=$priorityNames ?>
												</select>
											</td>
										</tr>
										</table>
									</td>
								</tr>
								<? /if ?>
								<tr class="SeparatedRow">
									<td><? wbs_label for="messageData[SENDER]" fieldName="SENDER" text=$mmStrings.sm_from_label skipColon=false ?></td>
									<td><? if $noSenderEmail ?><font color=red><? $mmStrings.sm_nosenderemail_label ?></font><? else ?>
											<select id="messageData[SENDER]" name="messageData[SENDER]" class="FormControl">
												<? html_options values=$senderIds selected=$messageData.SENDER output=$senderNames ?>
											</select>
										<? /if ?>
									</td>
								</tr>
								<? if !$noSenderEmail ?>
									<tr>
										<td valign=top><? conditionalOutput invalidField=$invalidField field='recipients' text=#invalidFieldHighlight# ?><? $mmStrings.sm_to_label|cat:": " ?></td>
										<td>
											<table class="FormLayout">
												<tr>
													<td class="FormElementCaption"><? $mmStrings.sm_included_label ?></td>
													<td>&nbsp;</td>
													<td>
															<select class="FormControl" name="currentObject" class="control"  style="background: url( <?  $currentObjectProp.BGIMAGE ?> ) no-repeat; background-color: #fff; background-position: 2px 2px; padding-left: 18px; color: <? $currentObjectProp.COLOR ?>; width: 300px;"  onChange="fillSelected(); this.form.submit()">
															<? assign var=optshown value=0 ?>
															<? foreach from=$FGL item=fgl_item key=ID ?>
																<? if $fgl_item.TYPE == 'FOLDERS' && $optshown == 0?> <optgroup label="<? $mmStrings.sm_folders_text ?>" style="color: #000;"> <? assign var=optshown value=1 ?> <? /if ?>
																<option value='<?  $fgl_item.ID ?>' style="background: url( <? $fgl_item.BGIMAGE ?> ) no-repeat; background-color: #fff; background-position: 2px 2px; padding-left: 18px; color: <? $fgl_item.COLOR ?>;" <?  if $fgl_item.ID == $currentObject ?>selected<? /if ?>><? $fgl_item.OFFSET ?><? $fgl_item.NAME|htmlsafe:true:true|truncate:47:"..."|sureecho  ?></option>
															<? /foreach ?>
															<? if $optshown == 1?> </optgroup> <? /if ?>
															</select>
													</td>
												</tr>
												<tr>
													<td>
														<select class="FormControl" name="includedContacts[]" size="8" style="width: 300px" class="control" multiple  ondblclick="moveDeleteComboItems('includedContacts[]', null, true )">
															<? foreach from=$includedContactsItems item=contact key=ID ?>
																<option value='<?  $ID ?>' class=<? $contact.STYLE ?> ><? $contact.OFFSET ?><? $contact.NAME|htmlsafe:tru:true ?></option>
															<? /foreach ?>
														</select>
													</td>
													<td>
														<? wbs_iconButton link="javascript: moveDeleteComboItems('contactsForInclude[]', 'includedContacts[]', false)" iconClass="Left" ?>
														<? wbs_iconButton link="javascript: moveDeleteComboItems( 'includedContacts[]', null, true  )" iconClass="Right" ?>
													</td>
													<td>
														<select class="FormControl" name="contactsForInclude[]"  size="8" style="width: 300px" class="control" multiple ondblclick="moveDeleteComboItems('contactsForInclude[]', 'includedContacts[]', false )">
															<? foreach from=$contactsForInclude item=contact key=ID ?>
																<option value='<?  $ID ?>'  class=<? $contact.STYLE ?> ><? $contact.OFFSET ?><? $contact.NAME|htmlsafe:tru:true ?></option>
															<? /foreach ?>
														</select><br>
													</td>
												</tr>
												<? if $showContactsNote ?>
												<tr>
													<td>&nbsp;</td>
													<td>&nbsp;</td>
													<td width=300><small><b><? $kernelStrings.app_note_text|cat:":"?></b> <? $mmStrings.sm_contacts_email_text ?></small></td>
												</tr>
												<? /if ?>
											</table>
										</td>
									</tr>

<?*
									<tr>
										<td valign=top><? conditionalOutput invalidField=$invalidField field='TOMORE' text=#invalidFieldHighlight# ?><? $mmStrings.sm_tomore_label|cat:": " ?></td>
										<td>
											<textarea name="messageData[TOMORE]" cols="30" rows="2" class="control" style="width: 100%"><? $messageData.TOMORE|htmlsafe_textarea:$edited ?></textarea>
										</td>
									</tr>
									<tr>
										<td colspan=2 height=5></td>
									</tr>
									<tr>
										<td></td>
										<td>
											<input type=checkbox name='messageData[IMAGES]' value='1' <? if $messageData.IMAGES=='1' ?>checked<? /if ?> > <? $mmStrings.sm_emebedding_imgs_label ?><br>
										</td>
									</tr>
*?>

									<tr>
										<td></td>
										<td>
											
											<table cellpadding="0" cellspacing="0" border="0">
											<tr>
												<td>
													<input class="FormControl" type=radio name='messageData[WHEN]' id='messageData[WHEN]'  onclick="hideLayer('layer')" value='now' <? if $messageData.WHEN=='now' ?>checked<? /if ?> >
												</td>
												<td>
													<? wbs_label for="messageData[WHEN]" fieldName="WHEN" text=$mmStrings.sm_sendnow_label skipColon=true ?>
												</td>
											</tr>
											<tr>
												<td>
													<input class="FormControl" type=radio name='messageData[WHEN]'  id='messageData[WHEN1]' value='later' onclick="showLayer('layer')" <? if $messageData.WHEN=='later' ?>checked<? /if ?> >
												</td>
												<td>
													<? wbs_label for="messageData[WHEN1]" fieldName="WHEN" text=$mmStrings.sm_sendlater_label skipColon=true ?>
												</td>
											</tr>
											
											<tr>
												<td>&nbsp;</td>
												<td>
													<div id="layer">
													<table class="FormLayout">
													<tr>
													<td>
														<? wbs_label for="messageData[WHENDATE]" fieldName="WHENDATE" text=$mmStrings.sm_senddate_label skipColon=false ?>
														<input class="FormControl" type=text style="width: 100px" class=control id="messageData[WHENDATE]" name="messageData[WHENDATE]" value="<? $messageData.WHENDATE ?>" maxlength="15" > <?include file="../../../common/html/classic/calendar.tpl"  style="margin-left: 2px" name="messageData[WHENDATE]"?>
													</td>
													<td>
														<? wbs_label for="messageData[WHENTIME]" fieldName="WHENTIME" text=$mmStrings.sm_sendtime_label skipColon=false ?>
														<select  class="FormControl"  style="width: 100px" class=control name="messageData[WHENTIME]" id="messageData[WHENTIME]" >
														<? foreach from=$timeArray item=time ?>
															<option value='<?  $time ?>' <? if $messageData.WHENTIME == $time?>selected<? /if ?>><? $time ?></option>
														<? /foreach?>
														</select>
													</td>
													</tr>
													<tr>
													<td colspan=2>
															<? wbs_note displayNoteMarker=true width="500px" smallFont=true ?>
																<? $serverTimeNote ?>
															<? /wbs_note ?>
													</td>
													</tr>
													</table>
												</div>
												</td>
											</tr>
											</table>
											
										</td>
									</tr>
									<tr>
										<td colspan=2 height=5></td>
									</tr>
								<? /if ?>

								<? /wbs_formContent ?>
								<? wbs_formButtonsPanel ?>
									<? wbs_buttonSet ?>
									<? if !$noSenderEmail ?>
										<? wbs_buttonSetButton name="sendbtn" caption=$mmStrings.app_send_btn onClick="return checkDate();" ?>
									<? /if ?>
										<? wbs_buttonSetButton name="cancelbtn" caption=$kernelStrings.app_cancel_btn ?>
									<? /wbs_buttonSet ?>
								<? /wbs_formButtonsPanel ?>
							<? /wbs_formLayout ?>
						</div>
						<div  ID="waitingcell" style="display:none">

							<? wbs_formCaption text=$mmStrings.sm_recipientslist_label ?>

							<? wbs_note displayNoteMarker=false width="500px" smallFont=false ?>
								<? $mmStrings.sm_gathering_info_wait_text ?>
							<? /wbs_note ?>

							<? wbs_note displayNoteMarker=false width="500px" smallFont=false ?>
								<img src="../cssbased/images/progress.gif" >
							<? /wbs_note ?>

						</div>
					<? else ?>

								<div ID="optionscell">

										<? wbs_note displayNoteMarker=false width="500px" smallFont=false ?>
											<? $numText ?>
										<? /wbs_note ?>

										<? if $recSendNowExceededText ?>
											<p><font style="color: red"><? $recSendNowExceededText ?></font><br><? $mmStrings.sm_sendnow_limitation_text ?>
										<? /if ?>
										
										<?if $SendAnother < $NumEmails?>
										<div style="padding-bottom: 16px;">
											<? $mmStrings.msg_already_sent?>: <strong><?$AlreadySent?></strong><br />
											<? $mmStrings.msg_sent_another?>: <strong><?$SendAnother?></strong>
										</div>
										<?/if?>
										<table class="NameValueList">
											<tr class="SeparatedRow">
												<td><? $mmStrings.sm_send_datetime_label|cat:":" ?></td>
												<th scope="col">
												<? if $messageData.WHEN == 'now' ?>
												<? $mmStrings.sm_send_now_text ?>
												<? elseif $adjourn eq 'true' ?>
												<? $mmStrings.sm_send_asoon_text ?>
												<? else ?>
												<? $messageData.WHENDATE ?> <? $messageData.WHENTIME ?>
												<? /if ?>
												</th>
											</tr>
										</table>

										<? wbs_buttonSet ?>

											<? if $showSendBtn && !$noSenderEmail?>
												<? wbs_buttonSetButton name="savebtn" caption=$mmStrings.app_send_btn onClick="return onSendingMesages('savebtn', false);"  ?>
											<? /if?>

											<? wbs_buttonSetButton name="sendcancelbtn" caption=$kernelStrings.app_cancel_btn ?>
										<? /wbs_buttonSet ?>

							</div>
							<div ID="waitingcell" style="display:none">

									<? wbs_formCaption text=$mmStrings.sm_sending_info_wait_text ?>

									<? wbs_note displayNoteMarker=false width="500px" smallFont=false ?>
										<? $mmStrings.sm_sendingwait_text ?>
									<? /wbs_note ?>

									<? wbs_note displayNoteMarker=false width="500px" smallFont=false ?>
										<img src="../cssbased/images/progress.gif" >
									<? /wbs_note ?>

							</div>
					<? /if ?>
			  <? else ?>
						<p class="header2"><? $mmStrings.sm_sending_stat_text ?></p>

						<table border="0" cellspacing="0" cellpadding="0" WIDTH=500>
						<? foreach from=$statArray item=stat ?>
							<tr>
								<td colspan=3><B><? $stat.MESSAGE.MMM_ID ?>.&nbsp;<? $stat.MESSAGE.MMM_SUBJECT|htmlsafe:true:true ?></B></td>
							</tr>
							<? if $stat.NOTSENT ?>
								<tr><td colspan=3><? $stat.NOTSENT ?></td></tr>
							<? else ?>
								<tr><td>&nbsp;&nbsp;</td><td>Sent:</td><td><? $stat.SENTCOUNT ?></td></tr>
								<tr>
									<td WIDTH=10></td><td><? if $stat.BOUNCEDCOUNT != 0 ?><a href=# onClick="return toggleVisibility('bounced<? $stat.MESSAGE.MMM_ID ?>');"><? /if ?>Bounced<? if $stat.BOUNCEDCOUNT != 0 ?><a href=# onClick="return toggleVisibility('bounced<? $stat.MESSAGE.MMM_ID ?>');"></a><? /if ?>:</td><td><? $stat.BOUNCEDCOUNT ?></td>
								</tr>
								<tr>
								<td></td>
								<td style="display:none" id="bounced<? $stat.MESSAGE.MMM_ID ?>" colspan=2>
									<small>
									<? foreach from=$stat.BOUNCED item=bounced ?>
									<? $bounced|htmlsafe:true:true ?><br>
									<? /foreach ?>
									</small>
								</td>
								</tr>
							 <? /if ?>
							<tr><td>&nbsp;</td></tr>
						<? /foreach ?>

						</table>

						<? include file="../../../common/html/classic/button.htm" align="left" name="cancelbtn" caption=$kernelStrings.app_ok_btn formname="form"?>
				<? /if ?>

			<? else ?>
				<? wbs_buttonSet ?>
					<? wbs_buttonSetButton name="cancelbtn" caption=$kernelStrings.app_cancel_btn ?>
				<? /wbs_buttonSet ?>
			<? /if ?>

			<input type="hidden" name="action" value="<?$action?>">
			<input type="hidden" name="opener" value="<? $opener ?>">
			<input type="hidden" name="doclist" value="<? $doclist?>">
			<input type="hidden" name="MMF_ID" value="<? $MMF_ID ?>">

		<? /wbs_pageLayout ?>
	</body>
</html>