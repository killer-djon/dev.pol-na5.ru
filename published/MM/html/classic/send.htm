<html>
<head>
<title>
<? $pageTitle ?>
</title>
<meta http-equiv="Content-Type" content="text/html; charset=<? $html_encoding ?>">
<link href="<? "styles.css"|stylesetitem:"classic":$styleSet ?>" rel="stylesheet" type="text/css">
<script src="../../../common/html/classic/styles/WebSubMenu.js"></script>
<script src="../../../common/html/classic/styles/popupmenu.js"></script>
<script language="JavaScript">
<!--
	function initFocus()
	{
		<? if $invalidField ?>
			focusFormControl('messageData[<? $invalidField ?>]');
		<? else ?>
			focusFirstFormControl();
		<? /if ?>
	}

	function fillSelected()
	{
		arr = new Array('includedContacts[]');
		fillSelectedLists( arr );
	}
	
	function onSendingMesages()
	{ 
		fillSelected(); 
		
		thisForm = document.forms[0];

		if ( document.getElementById ) 
		{
			var addFileCell = document.getElementById( 'optionscell' );
			if (addFileCell)
				addFileCell.style.display = "none";

			var attachMessageCell = document.getElementById( 'waitingcell' );
			if (attachMessageCell)
				attachMessageCell.style.display = "inline";
		}

		processTextButton( 'savebtn', 'form' );

		return false;
	}
	
	function toggleVisibility( id )
	{
		var el = document.getElementById(id)
		
		if ( el )
		{
			if ( el.style.display == 'none' )
				el.style.display = '';
			else
				el.style.display = 'none';
		}
		
		return false;
	}


//-->
</script>
</head>
<body bgcolor="#FFFFFF" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0" onLoad="initEditor();" onunload="update_textarea()">
<? strip ?>
<form action="<? $formLink ?>" method="post" enctype="multipart/form-data" name="form">
  <? include file="../../../common/html/classic/header.htm" nospace=1 ?>
  <? include file="../../../common/html/classic/toppanel_fix.htm" ?>
  <? include file="../../../common/html/classic/errblock.htm" errorStr=$errorStr ?>
  <? if !$fatalError ?>

	  <? if !$messagesSent ?>
	  <table border="0" cellspacing="0" cellpadding="0" width=80%>
	  <tr>
	    <td ID="optionscell">
			<table cellpadding=0 cellspacing=2 border=0>
				<? if !$noSenderEmail ?>
					<tr>
						<td><? $mmStrings.sm_priority_label|cat:": " ?></td>
						<td>
								<table cellpadding=0 cellspacing=0 border=0>
									<tr>
										<td>
											<select name="messageData[PRIORITY]" class="control" onChange="fillSelected(); this.form.submit()">
												<? html_options values=$priorityValues selected=$messageData.PRIORITY output=$priorityNames ?>
											</select>&nbsp;
										</td>
									</tr>
								</table>
						</td>
					</tr>
					<tr>
						<td colspan=2>&nbsp;</td>
					</tr>
				<? /if ?>
				<tr>
					<td><? $mmStrings.sm_from_label|cat:": " ?></td>
					<td><? if $noSenderEmail ?><font color=red><? $mmStrings.sm_nosenderemail_label ?></font><? else ?>
							<select name="messageData[SENDER]" class="control" onChange="fillSelected(); this.form.submit()">
								<? html_options values=$senderIds selected=$messageData.SENDER output=$senderNames ?>
							</select>&nbsp;
						<? /if ?>
						</td>
				</tr>
	
				<? if !$noSenderEmail ?>
				<tr>
					<td colspan=2 height=5></td>
					</tr>
					<tr>
						<td valign=top><? conditionalOutput invalidField=$invalidField field='recipients' text=#invalidFieldHighlight# ?><? $mmStrings.sm_to_label|cat:": " ?></td>
						<td>
							<table cellpadding=1 cellspacing=0 border=0>
								<tr>
									<td class=readonly_control><? $mmStrings.sm_included_label ?></td>
									<td>&nbsp;</td>
									<td class=readonly_control><? $mmStrings.sm_notincluded_label ?></td>
								</tr>
								<tr>
									<td>
										<select name="includedContacts[]" size="4" style="width: 233px" class="control" multiple ondblclick="moveComboItems('includedContacts[]', 'notincludedContacts[]')">
											<? html_options values=$includedContacts output=$includedContactsNames ?>
										</select>
									</td>
									<td>
										<p><a href="javascript: moveComboItems('notincludedContacts[]', 'includedContacts[]' )"><img src="<? "images/buttons/moveLeft.gif"|stylesetitem:"classic":$styleSet ?>" width="30" height="22" border="0"></a><br>
										<a href="javascript: moveComboItems('includedContacts[]', 'notincludedContacts[]' )"><img src="<? "images/buttons/moveRight.gif"|stylesetitem:"classic":$styleSet ?>" width="30" height="22" border="0"></a>
										</p>
									</td>
									<td>
										<select name="notincludedContacts[]" size="4" style="width: 232px" class="control" multiple ondblclick="moveComboItems('notincludedContacts[]', 'includedContacts[]')">
											<? html_options values=$notincludedContacts output=$notincludedContactsNames ?>
										</select>
									</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<td valign=top><? conditionalOutput invalidField=$invalidField field='TOMORE' text=#invalidFieldHighlight# ?><? $mmStrings.sm_tomore_label|cat:": " ?></td>
						<td>
							<textarea name="messageData[TOMORE]" cols="30" rows="2" class="control" style="width: 500px"><? $messageData.TOMORE|htmlsafe_textarea:$edited ?></textarea>
						</td>
					</tr>
					<tr>
						<td colspan=2 height=5></td>
					</tr>
					<!-- Attachments -->
	
					<tr>
						<td colspan=2><hr size=1 noshade></td>
					</tr>
	
					<tr>
						<td valign=top>
							<nobr><? $mmStrings.sm_messages_label|cat:":&nbsp;" ?></nobr>
						</td>
						<td width=500>
							<table cellpadding=0 cellspacing=0 border=0>
							<? foreach from=$messageList item=message ?>
										<tr>
											<td><? $message.MMM_ID ?>.&nbsp;</td>
											<td><? $message.MMM_SUBJECT|htmlsafe:true:true ?></td>
										</tr>
							<? /foreach ?>
							</table>
						</td>
					</tr>
					<tr>
						<td colspan=2 height=5></td>
					</tr>
					<tr>
						<td>&nbsp;</td>
						<td><? $totalFilesInfo ?></td>
					</tr>
	
					<? /if ?>
	        	</table>
				<BR><BR>
					<table width="100%" border="0" cellspacing="0" cellpadding="0">
	                <tr>
	                  <td>
	
	                    <? include file="../../../common/html/classic/button.htm" align="left" name="savebtn" caption=$mmStrings.app_send_btn formname="form" space_left=5 space_right=10  onClick="return onSendingMesages();"?>
	                    <? include file="../../../common/html/classic/button.htm" align="left" name="cancelbtn" caption=$kernelStrings.app_cancel_btn formname="form"?>
	                  </td>
	                  <td align="right">
	                  </td>
	                </tr>
	              </table>
		   </td>
	    </tr>
	    <tr>
				<td ID="waitingcell" style="display:none">
					<p class="header2"><? $mmStrings.sm_sending_text ?></p>
					<p><? $mmStrings.sm_sendingwait_text ?></p>
					<p><img src="<? "images/progress.gif"|stylesetitem:"classic":$styleSet:"MM" ?>" ></p>
					<?* <p><? include file="../../../common/html/classic/button.htm" align="left" link="mailmaster.php" caption=$kernelStrings.app_cancel_btn formname="form"?></p> *?>
				</td>
	    </tr>
	  </table>
	
	<? else ?>
		
		<p class="header2"><? $mmStrings.sm_sending_stat_text ?></p>
		
		<table border="0" cellspacing="0" cellpadding="0" WIDTH=500>

		<? foreach from=$statArray item=stat ?>
			<tr>
				<td colspan=3><B><? $stat.MESSAGE.MMM_ID ?>.&nbsp;<? $stat.MESSAGE.MMM_SUBJECT|htmlsafe:true:true ?></B></td>
			</tr>
			<? if $stat.NOTSENT ?>
				<tr><td colspan=3><? $stat.NOTSENT ?></td></tr>
			<? else ?>
				<tr><td>&nbsp;&nbsp;</td><td>Sent:</td><td><? $stat.SENTCOUNT ?></td></tr>
				<tr>
					<td WIDTH=10></td><td><? if $stat.BOUNCEDCOUNT != 0 ?><a href=# onClick="return toggleVisibility('bounced<? $stat.MESSAGE.MMM_ID ?>');"><? /if ?>Bounced<? if $stat.BOUNCEDCOUNT != 0 ?><a href=# onClick="return toggleVisibility('bounced<? $stat.MESSAGE.MMM_ID ?>');"></a><? /if ?>:</td><td><? $stat.BOUNCEDCOUNT ?></td>
				</tr>
			    <tr>
			    <td></td>
			    <td style="display:none" id="bounced<? $stat.MESSAGE.MMM_ID ?>" colspan=2>
			    	<small>
			    	<? foreach from=$stat.BOUNCED item=bounced ?>
			    	<? $bounced|htmlsafe:true:true ?><br>
			    	<? /foreach ?>
			    	</small>
			    </td>
			    </tr>
			 <? /if ?>
		    <tr><td>&nbsp;</td></tr>
		<? /foreach ?>
		
		</table>
		
		<? include file="../../../common/html/classic/button.htm" align="left" name="cancelbtn" caption=$kernelStrings.app_ok_btn formname="form"?>	
	<? /if ?>
  <? /if ?>
  <input type="hidden" name="action" value="<?$action?>">
  <input type="hidden" name="btndummy">
  <input type="hidden" name="edited" value="1">
  <input type="hidden" name="doclist" value="<? $doclist?>">
<?include file="../../../common/html/classic/pagefooter.htm"?>
</form>
<? /strip ?>
</body>
</html>